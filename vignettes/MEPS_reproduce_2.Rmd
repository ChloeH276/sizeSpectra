---
title: "MEPS_reproduce_2"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MEPS_reproduce_2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 5.7,
  fig.height = 7
  )

# A Prefix nulling hook from
# https://stackoverflow.com/questions/22524822/how-can-i-remove-the-prefix-index-indicator-1-in-knitr-output
#  by Stack Overflow 'Thell' (whose bio says they "apparently likes to keep an air of mystery
# about them."

# Make sure to keep the default for normal processing.
default_output_hook <- knitr::knit_hooks$get("output")

# Output hooks handle normal R console output.
knitr::knit_hooks$set( output = function(x, options) {

  comment <- knitr::opts_current$get("comment")
  if( is.na(comment) ) comment <- ""
  can_null <- grepl( paste0( comment, "\\s*\\[\\d?\\]" ),
                     x, perl = TRUE)
  do_null <- isTRUE( knitr::opts_current$get("null_prefix") )
  if( can_null && do_null ) {
    # By default R print output aligns at the right brace.
    align_index <- regexpr( "\\]", x )[1] - 1
    # Two cases: start or newline
    re <- paste0( "^.{", align_index, "}\\]")
    rep <- comment
    x <- gsub( re, rep,  x )
    re <- paste0( "\\\n.{", align_index, "}\\]")
    rep <- paste0( "\n", comment )
    x <- gsub( re, rep,  x )
  }

  default_output_hook( x, options )

})

knitr::opts_template$set("kill_prefix"=list(comment=NA, null_prefix=TRUE))
```

```{r setup}
library(sizeSpectra)
```



## Reproducing Figures 4 and 5 of MEPS paper

The simulated data takes a while to generate, bin and fit (over an hour on a fast laptop), and so results are saved
in the list `MLEbin.MEPS.default`. This list contains the fitted maximum likelihood
value (and confidence interval) of $b$ for each simulated data set, binning
method and fitting method (MLEmid or MLEbin).

To create `MLEbin.MEPS.default` run the next line (which is not evaluated by
this vignette but is run once in `data-raw/simulate-data2.R` to save
the list as part of this package):
```{r, eval=FALSE}
MLEbin.MEPS.default <- MLEbin.simulate()
```

The list contains three items (see `?MLEbin.simulate`):
```{r}
MLEbin.results <- MLEbin.MEPS.default   # just change this to use vignette for
                                        # other results
summary(MLEbin.results)
```

Figure 4 shows histograms of the estimates of $b$ for the MLEs for both methods and all four binning types:
```{r}
MLEmid.MLEbin.hist(MLEbin.results)
```

Figure 5 gives the confidence intervals for the MLEs for both methods and all four binning types:
```{r}
# These two lines just give a different inset for panel (e):
insetMat = matrix(rep(c(-0.01, -0.04), 4),
                  ncol=2,
                  byrow=TRUE)
insetMat[3, 1] = 0.3

MLEmid.MLEbin.conf(MLEbin.results,
                   insetMat = insetMat)
```

Table S.3 of related results TODO: fix the [1] bit, prob make dataframe.

|Binning type| Method | 5\% quantile |Median  |Mean  |95\% quantile |Percentage below true|
|:----- | :--------------- | -----------: |-----:  |---:  |-----------:  |--------------------:|


Make a dataframe of the results:
```{r, echo=TRUE}
# Taking from below, TODO then make into a function
# Not generalised to more than two fitting methods
MLEbin.table <- data.frame("Binning type" = NA,
                           "Method" = NA,
                           "Quantile.5" = NA,
                           "Median" = NA,
                           "Mean" = NA,
                           "Quantile.95" = NA,
                           "Percent.below.true" = NA)
for(i in 1:MLEbin.results$MLE.array.parameters$binTypes)
{
  for(j in 1:2)
  {
    MLEbin.table[2*i + j - 2, ] =
      c(MLEbin.results$MLE.array.parameters$binType.name[[i]],
        names(MLEbin.MEPS.default$MLE.array[1,1,])[j],
        qqtab(MLEbin.MEPS.default$MLE.array[ ,i,j],
              quants=c(0.05, 0.95),
              type="data.frame",
              true = MLEbin.results$MLE.array.parameters$b.known)
        )
  }
}
```


```{r, eval = FALSE}
Original, copying to above and then editing:  kEEP ME AS example  TODO update
MEE_reproduce_2.Rmd with type="Rmd"
for(j in 1:binTypes)                    # Loop over binning type; prob should
                                        # have just made a dataframe
  {
    print(paste(binType.name[[j]],
                " | ",
                MLEmethod.name[1],
                " | ",
                qqtab(MLE.array[ ,j,1], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
    print(paste(" | ", MLEmethod.name[2], " | ",
                qqtab(MLE.array[ ,j,2], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
}
```


<!--
# 5% and 95% values of MLEs, latex version (to copy into .tex file)
print("Binning type & Method & 5% quantile & Median & Mean & 95% quantile & Percentage below true \\ \\hline", quote=FALSE)

for(j in 1:binTypes)                    # Loop over binning type
  {
  print(paste(binType.name[[j]], " & ", MLEmethod.name[1], " & ",
      qqtab(MLE.array[ ,j,1], quants=c(0.05, 0.95)), "\\"), quote=FALSE)
  print(paste(" & ", MLEmethod.name[2], " & ",
      qqtab(MLE.array[ ,j,2], quants=c(0.05, 0.95)), "\\"), quote=FALSE)
}
-->

```{r, echo=FALSE}
knitr::opts_chunk$set(opts.label="kill_prefix")   # hasn't seemed to get rid of
                                        # [1] in next though. TODO
```

<!-- TODO MAKE this a function to make dataframe, and then should just be -->
<!-- printable in Rmarkdown. Remove eval=FALSE


|Binning type| Method | 5\% quantile |Median  |Mean  |95\% quantile |Percentage below true|
|:----- | :--------------- | -----------: |-----:  |---:  |-----------:  |--------------------:|
```{r, echo=FALSE, results='asis', eval=FALSE}
for(j in 1:binTypes)                    # Loop over binning type; prob should
                                        # have just made a dataframe
  {
    print(paste(binType.name[[j]],
                " | ",
                MLEmethod.name[1],
                " | ",
                qqtab(MLE.array[ ,j,1], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
    print(paste(" | ", MLEmethod.name[2], " | ",
                qqtab(MLE.array[ ,j,2], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
}
```
-->













<!--
# Range of widths of confidence intervals, may want to quote them but
#  unlikely need to report the full table.
print("Binning type & Method & Shortest CI & Widest CI\\ \\hline", quote=FALSE)
for(binTypeInd in 1:binTypes)
  {
  rangeVals = range(MLEconf.array[ ,binTypeInd, "MLEmid", "confMax"] -
    MLEconf.array[ ,binTypeInd, "MLEmid", "confMin"])
  print(paste(binType.name[[binTypeInd]], " & ", MLEmethod.name[1], " & ",
    rangeVals[1], " & ", rangeVals[2], "\\"), quote=FALSE)

  rangeVals = range(MLEconf.array[ ,binTypeInd, "MLEbin", "confMax"] -
    MLEconf.array[ ,binTypeInd, "MLEbin", "confMin"])
  print(paste(" & ", MLEmethod.name[2], " & ",
    rangeVals[1], " & ", rangeVals[2], "\\"), quote=FALSE)
}
-->
