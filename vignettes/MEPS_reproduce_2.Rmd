---
title: "MEPS_reproduce_2"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MEPS_reproduce_2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 5.7,
  fig.height = 7
  )

# A Prefix nulling hook from
# https://stackoverflow.com/questions/22524822/how-can-i-remove-the-prefix-index-indicator-1-in-knitr-output
#  by Stack Overflow 'Thell' (whose bio says they "apparently likes to keep an air of mystery
# about them."

# Make sure to keep the default for normal processing.
default_output_hook <- knitr::knit_hooks$get("output")

# Output hooks handle normal R console output.
knitr::knit_hooks$set( output = function(x, options) {

  comment <- knitr::opts_current$get("comment")
  if( is.na(comment) ) comment <- ""
  can_null <- grepl( paste0( comment, "\\s*\\[\\d?\\]" ),
                     x, perl = TRUE)
  do_null <- isTRUE( knitr::opts_current$get("null_prefix") )
  if( can_null && do_null ) {
    # By default R print output aligns at the right brace.
    align_index <- regexpr( "\\]", x )[1] - 1
    # Two cases: start or newline
    re <- paste0( "^.{", align_index, "}\\]")
    rep <- comment
    x <- gsub( re, rep,  x )
    re <- paste0( "\\\n.{", align_index, "}\\]")
    rep <- paste0( "\n", comment )
    x <- gsub( re, rep,  x )
  }

  default_output_hook( x, options )

})

knitr::opts_template$set("kill_prefix"=list(comment=NA, null_prefix=TRUE))
```

```{r setup}
library(sizeSpectra)
```



# Reproducing Figures 4, 5, ...TODO of MEPS paper

Simulated data takes a while to generate, bin and fit, and so results are saved
as data objects `MLE.array` and `MLEconf.array`. See `data-raw/simulate-data2.R`
for code - now making function `MLEbin.simulate()`. TODO: put that in help for data objects, and delete here.

<!-- TODO - decide if needed
print("Overall range of MLE values:")
print(range(MLE.array[ , , ]))
print("Overall range of confidence intervals:")
print(range(MLEconf.array[ , , , ]))
-->

```{r}

num.reps = MLE.array.known$num.reps
b.known = MLE.array.known$b.known
binTypes = MLE.array.known$binTypes
binType.name = MLE.array.known$binType.name
MLEmethod.name = dimnames(MLE.array)[[3]]

vertCol = "red"            # Colour for vertical lines in MLE histogram
vertThick = 1              # Thickness for vertical lines

inCol = "black"            # Colour for the true value being within the 95% CI
outCol = "red"             # Colour for the true value being outside the 95% CI

# Common x-axis and bin breaks for histograms
xrange = c(-2.4, -1.1)      # common width of axes
xbigticks = seq(xrange[1], xrange[2], by=0.4)
xsmallticks = seq(xrange[1], xrange[2], by=0.1)

yBigTickLab = seq(0, num.reps, 3000)
yBigTickNoLab = seq(0, num.reps, 1000)
ySmallTick = seq(0, num.reps, 500)

# Want -2 to be a midpoint of the Nth bin, which is yy above the minimum.
#  Say the 20th bin contains -2, so solve ((N+1)w + Nw)/2 = yy
#  gives  w = 2 * yy / (2*N + 1)
binwidth = 2 * (b.known - xrange[1]) / ( 2 * 10 + 1)
breakshist =  seq(xrange[1],
                  length=ceiling((xrange[2] - xrange[1])/binwidth)+1,
                  by=binwidth)

ylimA = c(0, 7000)
```

<!--
DELETE ME IF REST WORKS
for(binTypeInd in 1:binTypes)
  {
  par(omi = c(0.14, 0, 0.1, 0.15))      # outer margins (inches; set last to 0.2
                                        #  for single column)
  par(mfrow=c(2,2))

  oldmai = par("mai")
  par(mai=c(0.3, 0.5, 0.08, 0))  # Affects all four figures if don't change again
  par(xaxs="i", yaxs="i")    # Have to define here for hist
  par(mgp=c(2.0, 0.5, 0))    # puts axes labels closer I think
  par(cex = 0.8)             # With no option all text comes out a bit small

  # Histogram of MLEs for the two methods

  cexAxis = 1  # was 0.9      # font size for axes labels to make the y ones fit okay

  inset = c(0, -0.04)       # (default in confPlot)
  # xlabpos = 0.75       # just play with a number, as now using pos=4 in text

}                                   # End for(binTypeInd in 1:binTypes)
# ABOVE NOT NEEDED PROB
-->

```{r}
# Histograms of the MLE values for both methods and all four binning types.

par(omi = c(0.12, 0.05, 0.2, 0.0))      # outer margins in inches
par(mfrow=c(4,2)) #7,1))

par(mai=c(0.5, 0.5, 0.0, 0.3))
par(xaxs="i", yaxs="i")    # Have to define here for hist
par(mgp=c(2.0, 0.5, 0))    # Puts axes labels closer
par(cex = 0.8)             # With no option all text comes out a bit small

cexAxis = 0.9              # font size for axes labels to make the y ones
                           #  fit okay
inset = c(0, -0.04)

legLabMid = c("(a)", "(c)", "(e)", "(g)")    # label each panel in MLEmid column
legLabBin = c("(b)", "(d)", "(f)", "(h)")    # label each panel in MLEmid column

for(binTypeInd in 1:binTypes)
  {
    hist(MLE.array[ ,binTypeInd, "MLEmid"],
         xlim=xrange,
         breaks=breakshist,
         xlab="",
         ylab="",
         main="",
         axes=FALSE,
         ylim = ylimA)
    histAxes(yBigTickLab = yBigTickLab,
             yBigTickNoLab = yBigTickNoLab,
             ySmallTick = ySmallTick)
    legend("topright",
           paste(legLabMid[binTypeInd], binType.name[binTypeInd]),
           bty="n",
           inset=inset)

    hist(MLE.array[ , binTypeInd, "MLEbin"],
         xlim=xrange,
         breaks=breakshist,
         xlab="",
         ylab="",
         main="",
         axes=FALSE,
         ylim = ylimA)
    histAxes(yBigTickLab = yBigTickLab,
             yBigTickNoLab = yBigTickNoLab,
             ySmallTick = ySmallTick)
    legend("topright",
           paste(legLabBin[binTypeInd], binType.name[binTypeInd]),
           bty="n",
           inset=inset)
}

mtext(expression(paste("Estimate of ", italic(b))),
      side=1,
      outer=TRUE,
      line=-1)
mtext("Frequency",
      side=2,
      outer=TRUE,
      line=-1)

mtext("    MLEmid                                                MLEbin",
      side=3,
      outer=TRUE,
      line=0)
```

That should do Figure 4.

# Figure 5 - Confidence intervals for the MLEs for both methods and all four binning types.

```{r}
par(omi = c(0.2, 0.05, 0.22, 0.1))      # outer margins in inches
par(mfrow=c(4,2))

par(mai=c(0.3, 0.5, 0.08, 0))  # Affects all four figures if don't change agaiin
par(xaxs="i", yaxs="i")    # Have to define here for hist
par(mgp=c(2.0, 0.5, 0))    # Puts axes labels closer
par(cex = 0.8)             # With no option all text comes out a bit small
vertThick = 1              # Thickness for vertical lines

# Need a different inset for panel (e) MLEmid Linear 10.
insetMat = matrix(rep(c(-0.01, -0.04), 4),
                  ncol=2,
                  byrow=TRUE)
insetMat[3, 1] = 0.3

for(binTypeInd in 1:binTypes)
  {
  # confPlot returns a data.frame of intervals, but no need to save them
  #  for each binType.
    res = confPlot(as.data.frame(MLEconf.array[ ,binTypeInd, "MLEmid", ]),
                   legName = paste(legLabMid[binTypeInd],
                                   binType.name[binTypeInd]),
                   xLim = xrange,
                   xsmallticks = xsmallticks,
                   insetVal = insetMat[binTypeInd,],
                   insetVal2 = insetMat[binTypeInd,] + c(0, 0.12),
                   legLoc="topright",
                   yLab="")

    res = confPlot(as.data.frame(MLEconf.array[ ,binTypeInd, "MLEbin", ]),
                   legName=paste(legLabBin[binTypeInd],
                                 binType.name[binTypeInd]),
                   xLim = xrange,
                   xsmallticks = xsmallticks,
                   insetVal=inset,
                   insetVal2=inset + c(0, 0.12),
                   yLabels=FALSE,
                   legLoc="topright",
                   yLab="")
}

mtext(expression(paste("Estimate of ", italic(b))),
      side = 1,
      outer = TRUE,
      line = 0)
mtext("Sample number",
      side = 2,
      outer = TRUE,
      line = -1)

mtext("         MLEmid                                              MLEbin",
      side = 3,
      outer = TRUE,
      line = 0)
```

Table S.3 of related results TODO: fix the [1] bit, prob make dataframe.

<!--
# 5% and 95% values of MLEs, latex version (to copy into .tex file)
print("Binning type & Method & 5% quantile & Median & Mean & 95% quantile & Percentage below true \\ \\hline", quote=FALSE)

for(j in 1:binTypes)                    # Loop over binning type
  {
  print(paste(binType.name[[j]], " & ", MLEmethod.name[1], " & ",
      qqtab(MLE.array[ ,j,1], quants=c(0.05, 0.95)), "\\"), quote=FALSE)
  print(paste(" & ", MLEmethod.name[2], " & ",
      qqtab(MLE.array[ ,j,2], quants=c(0.05, 0.95)), "\\"), quote=FALSE)
}
-->

```{r, echo=FALSE}
knitr::opts_chunk$set(opts.label="kill_prefix")   # hasn't seemed to get rid of
                                        # [1] in next though. TODO
```

|Binning type| Method | 5\% quantile |Median  |Mean  |95\% quantile |Percentage below true|
|:----- | :--------------- | -----------: |-----:  |---:  |-----------:  |--------------------:|
```{r, echo=FALSE, results='asis'}
for(j in 1:binTypes)                    # Loop over binning type; prob should
                                        # have just made a dataframe
  {
    print(paste(binType.name[[j]],
                " | ",
                MLEmethod.name[1],
                " | ",
                qqtab(MLE.array[ ,j,1], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
    print(paste(" | ", MLEmethod.name[2], " | ",
                qqtab(MLE.array[ ,j,2], quants=c(0.05, 0.95), latex=FALSE)),
          quote=FALSE)
}
```

<!--
# Range of widths of confidence intervals, may want to quote them but
#  unlikely need to report the full table.
print("Binning type & Method & Shortest CI & Widest CI\\ \\hline", quote=FALSE)
for(binTypeInd in 1:binTypes)
  {
  rangeVals = range(MLEconf.array[ ,binTypeInd, "MLEmid", "confMax"] -
    MLEconf.array[ ,binTypeInd, "MLEmid", "confMin"])
  print(paste(binType.name[[binTypeInd]], " & ", MLEmethod.name[1], " & ",
    rangeVals[1], " & ", rangeVals[2], "\\"), quote=FALSE)

  rangeVals = range(MLEconf.array[ ,binTypeInd, "MLEbin", "confMax"] -
    MLEconf.array[ ,binTypeInd, "MLEbin", "confMin"])
  print(paste(" & ", MLEmethod.name[2], " & ",
    rangeVals[1], " & ", rangeVals[2], "\\"), quote=FALSE)
}
-->
