---
title: "MEPS_reproduce_1"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MEPS_reproduce_1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 5,
  fig.height = 5
)
```

```{r setup}
library(sizeSpectra)
```

# Reproducing Figures 2, 3, TODO.... of MEPS paper

 See the
paper for details, the aim of the vignette is to enable users to reproduce the
results so that they can see what functions are appropriate for their own data,
and perform further analyses as required.

```{r}
library(sizeSpectra)
```

## Figure 2 - example length-weight relationships for two species

```{r}
length_weight_plot()
```

# Figure 3 - how binned body-mass values get assigned to logarithmic size-class bins


```{r, fig.width=7.5, fig.height = 6}
num2 = 11       # number of log2 bin breaks
log2bins = 2^(0:(num2-1))    # on unlogged axes
log2binsStart = log2bins[-num2]
log2binsEnd = log2bins[-1]   # see segments in next figure
log2binsMid = colMeans(rbind(log2binsStart, log2binsEnd))  # midpoints (unlogged)

par(xaxs="i", yaxs="i")
par(mgp=c(2.0, 0.5, 0))    # puts axes labels closer I think
lThick = 3                 # Thickness for curves
par(lend="butt")           # To have butted line caps, need for thick lines.

# Axes ranges not automated - should do if want to start changing them.
plot(100,100, xlab="", ylab="Body mass, g", xlim=c(0, 12),
     ylim=c(-60, 800), xaxt="n")      # dummy points to set up axes.

axis(2, at = seq(0, 800, by=100), labels=rep("", 9), tck=-0.02)
axis(2, at = seq(0, 800, by=50), labels=rep("", 17), tck=-0.01)
axis(1, at = seq(1, 11, by=2), labels=c("Bin 1", "Bin 2", "Bin 3", "Bin 4",
                                   "Bin 5", "Bin 6"), tck=0, col.axis="blue")

# Could go back and use this throughout, as clearer (?). Do for one species here
#  then expand to do for two species (by having columns spName, LWa, LWb).
binsSp2 = data.frame(lenStart = lenBinsStart,
                     lenEnd = lenBinsEnd)
binsSp2 = dplyr::mutate(binsSp2,
                        lenMid = (lenStart +lenEnd)/2)
binsSp2 = dplyr::mutate(binsSp2,
                        massStart=lengthToMass(lenStart, LWa[2], LWb[2]),
                        massEnd=lengthToMass(lenEnd, LWa[2], LWb[2]),
                        massMid = (massStart + massEnd) / 2,
                        massOfLenMid = lengthToMass(lenMid, LWa[2], LWb[2]))
        # massOfLenMid is the mass corresponding to the converted midpoint
        #  of length bins, which is actually what gets used in MLEmid
# Now assign each original length bin a log2 mass bin:
ind=vector()             # index of which log2 bin each mass bin ends up in
for(ii in 1:dim(binsSp2)[1])
    {
        ind[ii] = which(binsSp2[ii,"massOfLenMid"] >= log2binsStart &
               binsSp2[ii,"massOfLenMid"] < log2binsEnd)
    }
binsSp2 = cbind(binsSp2,
                log2binStart = log2binsStart[ind],
                log2binEnd = log2binsEnd[ind],
                log2binMid = log2binsMid[ind])

# Show where example bin ends up

# 6 bins, therefore contain each pair in a span of 2 wide.
xVals = 1.5 + seq(0, 10, 2)     # xvals for vertical mass bins
for(egBin2 in 1:6)              # example bin number to highlight here
    {
    xVal = xVals[egBin2]        # where to have vertical bars
    turn= xVal - 0.5            # where to turn the line
    end = xVal - 0.8            # where to end the line
    # log2 bins:
    xLog2 = end - 0.2             # where to place log2 bins
    abline(v=seq(0, 12, 2), col="grey")
    segments(x0=rep(xLog2, num2),
             y0=log2binsStart,
             y1=log2binsEnd,
             col=c("black", "grey"),
             lwd=thick)
    points(rep(xLog2, num2-1),
           log2binsMid,
           pch="-",
           cex=2,
           col="purple")

    segments(x0=xVal,
             y0=massBinsStart[2,],
             y1=massBinsEnd[2,],
             col=colBins[2,],
             lwd=thick)
    lines(c(xVal, turn, end),
          c(rep(binsSp2[egBin2, "massOfLenMid"],2), binsSp2[egBin2,
                                                            "log2binMid"]),
          lty=1,
          lwd=1,
          col=col2[1])
    lines(c(xVal, turn, end),
          c(rep(binsSp2[egBin2, "massStart"], 2),
            binsSp2[egBin2, "log2binMid"]),
          lty=2,
          lwd=1,
          col=col2[1])
    lines(c(xVal, turn, end),
          c(rep(binsSp2[egBin2, "massEnd"], 2),
            binsSp2[egBin2, "log2binMid"]),
          lty=2,
          lwd=1,
          col=col2[1])
    # Arrow for the final part:
    shape::Arrows(x0=turn, y0=binsSp2[egBin2, "massOfLenMid"],
           x1 = end,
           y1 = binsSp2[egBin2, "log2binMid"],
           arr.adj=1,
           col = col2[1],
           lwd=1,
           arr.lwd=0.1,
           arr.type="triangle")
   }


```
