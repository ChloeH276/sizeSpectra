---
title: "MEPS_IBTS_2"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MEPS_IBTS_2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 6
)
```

```{r setup}
library(sizeSpectra)
```

# Analyses of IBTS data

TODO: This vignette analyses the IBTS data....

```{r}
library(sizeSpectra)
data = IBTS.data
data
```

<!-- From nSeaFungAnalysis.Snw, removing what isn't needed -->

Each row of `data` is a unique combination of year, species code and length
class. The `Number` column is the number of observed individuals of that species
in that length class in that year, `bodyMass` is the body mass of such an
individual, and `LWa` and `LWb` are the length-weight coefficients, used to
calculate `bodyMass`. To verify that each row is a unique combination of year,
species code and length class:
```{r}
data
unique = dim(dplyr::summarise(dplyr::group_by(data,
                                              Year,
                                              SpecCode,
                                              LngtClass),
                              count=dplyr::n()))[1]
unique

if( unique != dim(data)[1]) stop("something wrong with 'data'")
```



See if the number of length classes or species seems to change over time:
```{r, dataSumm}
dataSumm = dplyr::summarise(dplyr::group_by(data, Year),
                            uniqLngtClass = length(unique(LngtClass)),
                            uniqSpec = length(unique(SpecCode)))
par(mfrow=c(2,1)) #7,1))

plot(dataSumm$Year, dataSumm$uniqLngtClass, xlab="Year",
     ylab="No. unique length classes", type="o",
     ylim=c(0, max(dataSumm$uniqLngtClass)))
plot(dataSumm$Year, dataSumm$uniqSpec, xlab="Year",
     ylab="No. unique species", type="o", ylim=c(0, max(dataSumm$uniqSpec)))
```

Doesn't look to be any serious issue with this (no drastic changes in, for
     example, species identification through time).

The following code calculates, using `eightMethods.count()`, the slope or
exponent for each of the original eight methods for each year in turn, and saves a `.png` plot
 for each year that shows the fit of each method. It is
not run here because it takes a few hours (results are saved in TODO).
```{r doEachYear, echo=TRUE, eval=FALSE}
fullYears = unique(data$Year)
fullResults = data.frame()
for(ii in fullYears){
  eightMethodsRes = eightMethods.count(data = data,
                                       oneYear = ii,
                                       figName = "nSeaFung")
  fullResults = rbind(fullResults, eightMethodsRes)
}
```


Now to plot Figure 1, time series of each estimate of `b` for each method, and
fit regression.

```{r, fig.height = 7.5}
# , caption= "For each method in turn, the estimated exponents $b$ (circles) and 95\% confidence intervals (vertical bars) are shown for every year. The fit of a weighted linear regression with 95\% confidence interval is shown as red lines if the trend can be considered statistically significant from 0 ($p<0.05$), and in grey if the trend is not statistically significantly different from 0 ($p \geq 0.05$). The y-axes are the same for (d)-(h)."}
par(omi = c(0.14, 0, 0.1, 0.15))      # outer margins in inches
par(mfrow=c(4,2))

oldmai = par("mai")
par(mai=c(0.3, 0.5, 0.08, 0))  # Affects all four figures if don't change agaiin
par(mgp=c(2.0, 0.5, 0))
par(cex = 0.8)
vertThick = 1                  # Thickness for vertical lines

fullResFive = dplyr::filter(fullResults,
                            Method %in% c("LBmiz", "LBbiom", "LBNbiom",
                                          "LCD", "MLE"))
yLim = c(min(fullResFive$confMin), max(fullResFive$confMax))

# Each of these plots a panel for one method. Define xLim if the default
#  (integer-based calculation) is not suitable

trendResults = data.frame()  # Will have one row of trend results for each method

# Could make into a loop, but this works
res = timeSerPlot(dplyr::filter(fullResults, Method == "Llin"), legName = "(a) Llin",
            method = "Llin", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LT"), legName = "(b) LT",
            yLab="", method = "LT", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LTplus1"),
    legName = "(c) LTplus1", method = "LTplus1", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LBmiz"), legName = "(d) LBmiz",
            yLim=yLim, yLab="", method = "LBmiz", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LBbiom"),
    legName = "(e) LBbiom", yLim=yLim, method = "LBbiom", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LBNbiom"),
    legName = "(f) LBNbiom", yLim=yLim, yLab="", method = "LBNbiom",
    weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "LCD"), legName = "(g) LCD",
    yLim=yLim, method = "LCD", weightReg=TRUE)
trendResults = rbind(trendResults, res)

res = timeSerPlot(dplyr::filter(fullResults, Method == "MLE"), legName = "(h) MLE",
    yLim=yLim, yLab="", method = "MLE", legPos = "bottomleft",
    weightReg=TRUE)
trendResults = rbind(trendResults, res)

mtext("Year", side=1, outer=TRUE, line=-0.2, cex=0.8)
```

TODO:

<!--

trendResultsTab = xtable(dplyr::select(trendResults, -adjRsquared),
  digits=c(0, 0, 4, 4, 4, 2, 2),
  caption="Summary of weighted regression analysis
  of trend through time of the estimated exponent $b$, as estimated using each
  of the eight methods. `Trend' is the estimated annual trend, with
  95\\% confidence intervals given by `Low' and `High';
  p is the p-value for the probability that the trend is significantly
  different to 0, and $R^2$ is the coefficient of determination.
  If $p \\geq 0.05$ then the trend can be considered not
  significantly different to 0. If $p<0.05$ then a negative trend indicates
  a statistically significant decline in the exponent over time, and
  a positive trend indicates a statistically significant increase.",
  lab="tab:trendRes")



TODO:

print(trendResultsTab, table.placement="tp", caption.placement="top",
    include.rownames = FALSE, sanitize.text.function=function(x){x})  # was !ht

-->

TODO:
<!--
# example lines of data, to maybe have as a table in Part 2 manuscript.
egData = data[c(1:6, (dim(data)[1]-5):(dim(data)[1])), ]
egData = dplyr::mutate(egData, Biomass = Number * bodyMass)
names(egData) = c("Year", "Species", "Length class (cm)", "Number (h$^{-1}$)", "alpha",          "beta", "Body mass (g)", "Total biomass (g)")
egDataTab = xtable(egData, digits=c(0, 0, 0, 0, 3, 4, 4, 2, 2),
  caption="Example data (first six and last six rows) from the ** data set, to demonstrate the information available. Each row represents a unique combination of year, species and length class. `Number' gives the number of individuals (per hour of **trawling) observed for that combination, and can be non-integer because counts of individual fish are scaled by tow duration**. Fish lengths are assigned into length classes, where the value of `Length class' (cm) is the minimum value of the length bin; for this data set fish were usually assigned to 1-cm length classes, and occasionally 0.5~cm. Parameters $\\alpha$ and $\\beta$ are the length-weight coefficients for each particular species, and `Body mass' (g) is the resulting estimated body mass for individuals of that species and length class. `Biomass' (g) is the total biomass of individuals for each row.**TO DO manually: **Change to $\\alpha$ and $\\beta$. Replace SpecCode by actual species name. Add in rows of $\\cdot \\cdot \\cdot$. Manually split column headers over two rows.", lab="tab:egData")  # digits[1] is row.names

-->
TODO:
```{r, eval=FALSE}
print(egDataTab, table.placement="tp", caption.placement="top",
    include.rownames = FALSE) #, sanitize.text.function=function(x){x})  # was !ht
# To get particular species names:
# load("ibtsQ1cpuelength.RData")
# dataOrig = tbl_df(q1)
# dplyr::filter(dataOrig, AphiaID == 105814)
# Gives:
# 105814 NS-IBTS 2012       1    3 Sciliorhinus caniculus      340
# 105814 NS-IBTS 1999       1    3  Scyliorhinus canicula      580
# 105814 NS-IBTS 2014       1    5  Scyliorhinus canicula      370
# Great, two names. Go with Scyliorhinus canicula (Smallspotted Catshark
#  [Sharks of the world, Compagno et al.])
# 154675: Lumpenus lampretaeformis  (Snakeblenny)
# 274304: Microchirus variegatus (Thickback SOle
```
